\documentclass{jsarticle}
\usepackage{amsmath}
\usepackage{ascmac}
\usepackage{amsthm}
\usepackage{tgpagella}
\usepackage{newpxmath}
\usepackage{algorithm}
\usepackage{url}
\usepackage{bm}
\usepackage{makeidx}
\author{夕叢霧香 (@kirika\_comp)}
\title{整数論テクニック集 DRAFT}

\newcommand{\Z}{\mathbb{Z}}
\newcommand{\legendre}[2]{\left(\frac{#1}{#2}\right)}
\theoremstyle{definition}
\newtheorem{theorem}{定理}[section]
\newtheorem{example}[theorem]{例}
\makeindex
\begin{document}
\maketitle
 \section{はじめに}
これは、競技プログラミングで使える整数論のテクニックをまとめた文章です。
AtCoder の青から赤下位程度をターゲットにしています。

整数論の問題は得てして「地頭ゲー」などと呼ばれやすいですが、実はそうではなく、知識を持っていることで解ける問題が多いです。しかし、その知識については、日本の競技プログラマーたちには、
あまり知られていないように見えます。そのため、この文章を書くことにしました。

コメント等はTwitter (@kirika\_comp) までお願いします。
 \section{${}\bmod p$ のアルゴリズム}
  \subsection{基礎知識}
  \label{subsec:group-preliminaries}
   \subsubsection{フェルマーの小定理}
   $p$が素数で$a \not \equiv 0 \pmod p$ のとき、 $a^{p-1} \equiv 1 \pmod p$が成立します。
   \subsubsection{平方剰余}
   $a \equiv x^2 \pmod p$ となる $x$ が存在する場合、$a$を${}\bmod p$ における \emph{平方剰余}\index{へいほうじょうよ@平方剰余} (\emph{quadratic residue})、そうでない場合 $a$ を\emph{平方非剰余}\index{へいほうひじょうよ@平方非剰余} (\emph{quadratic non-residue})と呼びます。
   $p$ が奇素数の時、0を除くと平方剰余と平方非剰余の割合は1:1です。
   また、$a\not\equiv 0 \pmod p$ のとき$a^{(p-1)/2}$ は ${}\bmod p$ で $1$ か $-1$ かのどちらかですが、$a$ が平方剰余のとき$1$、平方非剰余のとき$-1$です。
   \begin{example}
    $p = 13$ の場合を考えます。このとき、平方剰余は$0=0^2$,$1=1^2$,$3\equiv 4^2$,$4=2^2$,$9=3^2$,$10\equiv 6^2$,$12 \equiv 5^2 \pmod{13}$の7個です。0を除外すると1,3,4,9,10,12の6個で、${}\bmod 13$の0以外の同値類12個のうち、ちょうど半分が平方剰余、もう半分が平方非剰余です。なお、適当な平方非剰余$z$をとると、0以外の平方剰余に$z$を掛けたものはすべて平方非剰余です。例えば、$z=2$とすると、1,3,4,9,10,12に2を掛けて${}\bmod 13$したもの(2,6,8,5,7,11)はすべて平方非剰余です。
   \end{example}
   \subsubsection{加法群}
   $\Z/p\Z$の話 TODO
   \subsubsection{乗法群}
   $(\Z/p\Z)^*$の話 TODO

   平方剰余全体は$(\Z/p\Z)^*$の部分群 TODO
\subsection{mod\_sqrt, Tonelli-Shanks のアルゴリズム}
\subsubsection{問題}
ある $x$ について $a \equiv x^2 \pmod p$ が成り立つ $a$ が与えられる。この時、$x$ を求めよ。

\subsubsection{解法}
まず、簡単のため $p = 2$ の場合を除外します(このときは$a^2 \equiv a \pmod 2$ なので簡単)。また$a \equiv 0 \pmod p$ の場合も除外します($0^2 = 0$なので簡単)。
$p$ が${}\bmod 4$ で3の時は簡単です。$x \equiv a^{(p+1)/4}$とすると、$x^2 \equiv a^{(p+1)/2}$ です。ここで、$a \equiv y^2$ となる $y$ が存在するので、$a^{(p-1)/2}\equiv y^{p-1}\equiv 1 \pmod p$ です。
だから、$x^2 \equiv a$ が成り立ちます。

$p$ が ${}\bmod 4$ で 1の時は結構複雑なことをします。ここではTonelli-Shanksの方法と呼ばれるアルゴリズムを説明します。

\subsubsection{Tonelli-Shanks (トネリ-シャンクス) のアルゴリズム}
[reference]\url{https://en.wikipedia.org/wiki/Tonelli%E2%80%93Shanks_algorithm}

入力: $p (\ge 3)$: 奇素数, $a (\not \equiv 0 \pmod p)$: 平方剰余

出力: $r^2 \equiv a \pmod p$ を満たす$r$

$p = q \times 2^s + 1$ とします。 ($s \ge 1$, $q$は奇数)

注意: 以下の疑似コードでは代入は全部同時に行います。特に5.で、$t$に代入する値は前の $c$ によって決まります。

注意2: 本来の Tonelli-Shanks とは違いますが、不変量を考えることで筆者が復元できたのが以下のアルゴリズムなので、こちらの方が理解しやすいと思います。(効率は悪い)

\begin{algorithm}                      
\caption{単純化された Tonelli-Shanks のアルゴリズム}
\label{alg1}
1. $z^{(p-1)/2} \equiv -1 \pmod p$ となるような $z$ を選ぶ。このような $z$ は確率1/2でヒットするため、何個か試せば必ず見つかる。

2. $m := s, c:\equiv z^q, t :\equiv a^q, r :\equiv a^{(q + 1)/2}$ とする。以降不変量 $\bm{r^2\equiv at \pmod p, t^{2^{m - 1}} \equiv 1 \pmod p, c^{2^{m-1}} \equiv -1 \pmod p}$ を崩さないように注意して操作する。

3. 以降 $m$ を減らしていく。$m$ が1なら終了。そうでなければ、$t^{2^{m-2}} \equiv 1 \pmod p$ なら4.へ、そうでなければ5.へ行く。

4. $c :\equiv c^2 \pmod p, m := m - 1$, 6.へ行く。

5. $c :\equiv c^2 \pmod p, t :\equiv c^2 t \pmod p, r :\equiv cr \pmod p, m := m - 1$ を\emph{全て同時に}代入する, 6.へ行く。

6. 3.へ行く。

\end{algorithm}
終了時には$m=1$なので、$t\equiv 1 \pmod p$になっているはずで、そのときの $r$ が求める値です。(不変量 $r^2\equiv at \pmod p$ に注意。)



C++での実装は以下のようになります。
\begin{verbatim}
#include<random>
using namespace std;
typedef long long lint;

lint powmod(lint a,lint e,lint p){
  lint r=1;
  for(int i=63;i>=0;--i){
    r=r*r%p;
    if(e&1LL<<i)r=r*a%p;
  }
  return r;
}

// p:素数, aは0でなく、平方剰余
lint simplified_tonelli_shanks(lint p,lint a){
  mt19937 mt;
  if(powmod(a,(p-1)/2,p)!=1)return -1;
  lint q=p-1;
  lint m=0;
  while(q%2==0)q/=2,m++;
  lint z;
  do{
    z=mt()%p;
  }while(powmod(z,(p-1)/2,p)!=p-1);
  lint c=powmod(z,q,p);
  lint t=powmod(a,q,p);
  lint r=powmod(a,(q+1)/2,p);
  for(;m>1;--m){
    lint tmp=powmod(t,1<<(m-2),p);
    if(tmp!=1)
      r=r*c%p,t=t*(c*c%p)%p;
    c=c*c%p;
  }
  return r;
}
	
\end{verbatim}

例を挙げて見ていきましょう。
$p = 41$, $a = 8$ とします。

$p = 5 * 2^3 + 1$ なので、$q = 5, s = 3$ です。
$z$ として、ここでは 7 をとります。

$m := 3, c :\equiv 7^5 = 16807 \equiv 38, t :\equiv 8^5 = 32768 \equiv 9, r \equiv 8^3 = 512 \equiv 20$ となります。 (${} \bmod 41$ は適宜省略)

 \begin{table}[htb]
  \begin{center}
  \begin{tabular}[t]{|c|c|c|c|}
   \hline
   $m$ & $c$ & $t$ & $r$ \\ \hline
   3 & 38 & 9 & 20 \\
   2 & 9 & 40 & 22 \\
   1 & 40 & 1 & 34 \\ \hline
  \end{tabular}
  \end{center}
 \end{table}


よって、$x \equiv \pm 34 (=\mp 7)$ が答えになります。


以上のアルゴリズムで、4.のパートに無駄があります。4.では$c$と$m$しか変更していないので、$t^{2^i}\not \equiv 1 \pmod p$ となる最大の $i$ が見つけられれば、4.の操作をまとめることができます。このアイデアを使うのが、本来の Tonelli-Shanks のアルゴリズムです。

(TODO Wikipedia のTonelli-Shanks の説明)

\begin{itembox}[l]{COLUMN}
 群論的なアプローチをすると、もっと綺麗な見方が得られます。
$(\Z/p\Z)^* \cong \Z/(p-1)\Z \cong (\Z/2^s\Z) \times (\Z/q\Z)$ の2冪成分(2-Sylow部分群\index{Sylowぶぶんぐん@Sylow部分群}) $H = \Z/2^s\Z$ を考えます。このとき、$z$ と $t$ は $H$ の元であることがわかります。$t$が$1$になるように、うまく$H^2$の元で調整しているわけです。
\end{itembox}
 \section{平方剰余の相互法則}
  \subsection{ルジャンドル記号}
  TODO ルジャンドル記号\index{るじゃんどるきごう@ルジャンドル記号}
  \subsection{平方剰余の相互法則}
  以下の定理が成り立つことが知られています。
  \begin{theorem}[平方剰余の相互法則]
   $p, q \ge 3$ を奇素数とする。このとき、以下が成立する。
   \begin{displaymath}
    \left(\frac{p}{q}\right)\left(\frac{q}{p}\right) = (-1)^{\frac{p-1}{2} \times \frac{q-1}{2}}
   \end{displaymath}
  \end{theorem}
  \begin{theorem}[補充法則]
   $p \ge 3$ を奇素数とする。このとき、以下が成立する。
   \begin{displaymath}
    \legendre{-1}{p} = (-1)^{\frac{p-1}{2}},
    \legendre{2}{p} = (-1)^{\frac{p^2-1}{8}}
   \end{displaymath}
  \end{theorem}
  これを利用することで、ルジャンドル記号を計算できます。
  \begin{example}
   \label{ex:legendre-3}
   $p \neq 2,3$を、2,3以外の素数とします。このとき、
   $\legendre{3}{p}$ は、$p$ を12で割った余りで完全に決まります。
   \begin{displaymath}
    \legendre{3}{p} = (-1)^{\frac{p-1}{2}}\legendre{p}{3}
   \end{displaymath}
   ここで、
   \begin{displaymath}
    \legendre{p}{3} = \begin{cases}
		       1 & \mbox{if }p\equiv 1 \pmod 3 \\
		       -1 & \mbox{if }p\equiv 2 \pmod 3
		      \end{cases}
   \end{displaymath}
   なので、
   \begin{displaymath}
    (-1)^{\frac{p-1}{2}} = \begin{cases}
			    1 & \mbox{if }p \equiv 1 \pmod 4 \\
			    -1 & \mbox{if }p \equiv 3 \pmod 4
			   \end{cases}
   \end{displaymath}
   と合わせ、
   \begin{displaymath}
    \legendre{3}{p} = \begin{cases}
		       1 & \mbox{if }p\equiv 1,11 \pmod{12} \\
		       -1 & \mbox{if }p\equiv 5,7 \pmod{12}
		      \end{cases}
   \end{displaymath}
   が得られます。
  \end{example}
\printindex
\end{document}
