\documentclass{jsarticle}
\author{夕叢霧香 (Kirika Yuumura, @kirika\_comp)}
\title{整数論テクニック集 DRAFT}

\input{./macros.tex}
\makeindex
\begin{document}
\maketitle
 \section{はじめに}
 これは、競技プログラミングで使える整数論のテクニックをまとめた文章です。
 AtCoder の青から赤下位程度をターゲットにしています。

 整数論の問題は得てして「地頭ゲー」などと呼ばれやすいですが、実はそうではなく、知識を持っていることで解ける問題が多いです。しかし、その知識については、日本の競技プログラマーたちには、
 あまり知られていないように見えます。そのため、この文章を書くことにしました。
 
 コメント等はTwitter (@kirika\_comp) までお願いします。
 \section{mod $p$上の計算}
 \label{sec:mod-p-arithmetic}
  \subsection{基本: 整数の加減乗除\level{1}}
  計算結果が大きすぎるため、${} \bmod (10^9+7)$で出力せよ、という問題が結構あります。
  このような問題の場合は、最終結果を${} \bmod (10^9+7)$するのではなく、途中結果も${} \bmod (10^9+7)$することで、途中結果が大きくなりすぎるのを防ぐことができます。
  \subsection{基本: 分数の加減乗除\level{2}}
  たまに、分数についての言及があることがあります。大抵以下のような形をしています。
  \begin{center}
   答えは分数$A/B$ になる。このとき、$B$ の mod $(10^9+7)$ での逆元を$B^{-1}$ として、$A \times B^{-1} \bmod (10^9 + 7)$を出力せよ。
  \end{center}
  これも、特別な配慮などはせずに、途中結果をmod $(10^9+7)$ で保持しておくだけで、計算が正しく行えます。
  \begin{itembox}[l]{例題}
   \begin{itemize}
    \item Codeforces Round \#465 (Div. 2) D. Fafa and Ancient Alphabet
   \end{itemize}
  \end{itembox}
  \begin{itembox}[l]{COLUMN}
   専門用語を使うと、これは環準同型$\Z \to \Z/(10^9+7)\Z$が、体の準同型$\Q \to \Z/(10^9+7)\Z$ に拡張できる、ということができます(ただし、細かい点を除く)。興味のある人は、調べてみてください。
  \end{itembox}
 \section{二分累乗法\level{1}}
 \label{sec:squaring-by-exponentiation}
 二分累乗法は基本 TODO
  \subsection{群的構造を見つけて二分累乗する\level{2}}
  \begin{itembox}[l]{例題}
   $\cos \theta = \frac{d}{l}$であるような$\theta$に対して、$\cos t\theta$は有理数であることが証明できる。$l\cos t\theta = \frac{p}{q}$であるとき、$pq^{-1} \bmod (10^9+7)$を求めよ。
   \begin{itemize}
    \item 部分点(15/100点): $t$は2冪である。つまり、ある0以上の整数$p$について$t=2^p$。
    \item 満点(100点): $1 \le t \le 10^{18}$, $t$は整数。
   \end{itemize}
   (出典: CodeChef February Challenge 2018 (FEB18) >> Broken Clock (BROCLK))
  \end{itembox}
  部分点解法は、2倍角の公式$\cos 2\theta = 2\cos^2\theta - 1$を利用して、$p$回の計算を行うことでできます。

  問題は満点解法の方で、愚直にやると$t$倍角の公式が必要になってきて、不可能とは言わないまでも面倒です。そこで、ド・モアブルの公式 (de Moivre's formula)
  \begin{displaymath}
   \cos t\theta + i\sin t\theta = (\cos\theta + i\sin\theta)^t
  \end{displaymath}
  を利用して、強引に冪乗公式に持っていくことを考えましょう。
  式の形から、$\cos \theta + i\sin\theta$なる数の計算、およびそれの累乗の計算ができれば良いことになります。ここで、以下のようにペアを用いて数を表現することにします:
  \begin{displaymath}
   \langle a, b\rangle \mapsto a + ib\sin \theta
  \end{displaymath}
  これにより掛け算、それゆえ冪乗が、整数ペアの上の演算として実装できます。どのようにするかみていきましょう。

  まず、$\cos\theta + i\sin\theta$はもちろん、$\langle \cos\theta,1\rangle=\langle d/l,1\rangle$として表現されます。掛け算についてですが、
  \begin{displaymath}
   (a,b) \times (c,d) = (a+ib\sin\theta)(c+id\sin\theta)
   =(ac+bd(\sin^2\theta-1))+i(ad+bc)\sin\theta
   =\langle ac+bd(\sin^2\theta-1), ad+bc\rangle
  \end{displaymath}
  より、問題なく実装することができます。これによりべき乗も問題なく実装でき、問題が解けます。
\lstinputlisting[caption=BROCLK.cpp,label=BROCLK]{FEB18-BROCLK.cpp}
 \section{${}\bmod p$ のアルゴリズム}
  \subsection{基礎知識}
  \label{subsec:group-preliminaries}
   \subsubsection{フェルマーの小定理\level{1}}
   $p$が素数で$a \not \equiv 0 \pmod p$ のとき、 $a^{p-1} \equiv 1 \pmod p$が成立します。
   \subsubsection{平方剰余\level{3}}
   $a \equiv x^2 \pmod p$ となる $x$ が存在する場合、$a$を${}\bmod p$ における \emph{平方剰余}\index{へいほうじょうよ@平方剰余} (\emph{quadratic residue})、そうでない場合 $a$ を\emph{平方非剰余}\index{へいほうひじょうよ@平方非剰余} (\emph{quadratic non-residue})と呼びます。
   $p$ が奇素数の時、0を除くと平方剰余と平方非剰余の割合は1:1です。
   また、$a\not\equiv 0 \pmod p$ のとき$a^{(p-1)/2}$ は ${}\bmod p$ で $1$ か $-1$ かのどちらかですが、$a$ が平方剰余のとき$1$、平方非剰余のとき$-1$です。
   \begin{example}
    $p = 13$ の場合を考えます。このとき、平方剰余は$0=0^2$,$1=1^2$,$3\equiv 4^2$,$4=2^2$,$9=3^2$,$10\equiv 6^2$,$12 \equiv 5^2 \pmod{13}$の7個です。0を除外すると1,3,4,9,10,12の6個で、${}\bmod 13$の0以外の同値類12個のうち、ちょうど半分が平方剰余、もう半分が平方非剰余です。なお、適当な平方非剰余$z$をとると、0以外の平方剰余に$z$を掛けたものはすべて平方非剰余です。例えば、$z=2$とすると、1,3,4,9,10,12に2を掛けて${}\bmod 13$したもの(2,6,8,5,7,11)はすべて平方非剰余です。
   \end{example}
   \subsubsection{加法群\level{4}}
   $\Z/p\Z$の話 TODO
   \subsubsection{乗法群\level{4}}
   $(\Z/p\Z)^*$の話 TODO

   平方剰余全体は$(\Z/p\Z)^*$の部分群 TODO
\subsection{mod\_sqrt, Tonelli-Shanks のアルゴリズム\level{3}}
\subsubsection{問題}
ある $x$ について $a \equiv x^2 \pmod p$ が成り立つ $a$ が与えられる。この時、$x$ を求めよ。

\subsubsection{解法}
まず、簡単のため $p = 2$ の場合を除外します(このときは$a^2 \equiv a \pmod 2$ なので簡単)。また$a \equiv 0 \pmod p$ の場合も除外します($0^2 = 0$なので簡単)。
$p$ が${}\bmod 4$ で3の時は簡単です。$x \equiv a^{(p+1)/4}$とすると、$x^2 \equiv a^{(p+1)/2}$ です。ここで、$a \equiv y^2$ となる $y$ が存在するので、$a^{(p-1)/2}\equiv y^{p-1}\equiv 1 \pmod p$ です。
だから、$x^2 \equiv a$ が成り立ちます。

$p$ が ${}\bmod 4$ で 1の時は結構複雑なことをします。ここではTonelli-Shanksの方法と呼ばれるアルゴリズムを説明します。

\subsubsection{Tonelli-Shanks (トネリ-シャンクス) のアルゴリズム}
[reference]\url{https://en.wikipedia.org/wiki/Tonelli%E2%80%93Shanks_algorithm}

入力: $p (\ge 3)$: 奇素数, $a (\not \equiv 0 \pmod p)$: 平方剰余

出力: $r^2 \equiv a \pmod p$ を満たす$r$

$p = q \times 2^s + 1$ とします。 ($s \ge 1$, $q$は奇数)

注意: 以下の疑似コードでは代入は全部同時に行います。特に5.で、$t$に代入する値は前の $c$ によって決まります。

注意2: 本来の Tonelli-Shanks とは違いますが、不変量を考えることで筆者が復元できたのが以下のアルゴリズムなので、こちらの方が理解しやすいと思います。(効率は悪い)

\begin{algorithm}                      
\caption{単純化された Tonelli-Shanks のアルゴリズム}
\label{alg1}
1. $z^{(p-1)/2} \equiv -1 \pmod p$ となるような $z$ を選ぶ。このような $z$ は確率1/2でヒットするため、何個か試せば必ず見つかる。

2. $m := s, c:\equiv z^q, t :\equiv a^q, r :\equiv a^{(q + 1)/2}$ とする。以降不変量 $\bm{r^2\equiv at \pmod p, t^{2^{m - 1}} \equiv 1 \pmod p, c^{2^{m-1}} \equiv -1 \pmod p}$ を崩さないように注意して操作する。

3. 以降 $m$ を減らしていく。$m$ が1なら終了。そうでなければ、$t^{2^{m-2}} \equiv 1 \pmod p$ なら4.へ、そうでなければ5.へ行く。

4. $c :\equiv c^2 \pmod p, m := m - 1$, 6.へ行く。

5. $c :\equiv c^2 \pmod p, t :\equiv c^2 t \pmod p, r :\equiv cr \pmod p, m := m - 1$ を\emph{全て同時に}代入する, 6.へ行く。

6. 3.へ行く。

\end{algorithm}
終了時には$m=1$なので、$t\equiv 1 \pmod p$になっているはずで、そのときの $r$ が求める値です。(不変量 $r^2\equiv at \pmod p$ に注意。)



C++での実装は以下のようになります。
\lstinputlisting[caption=tonelli-shanks.cpp]{tonelli-shanks.cpp}

例を挙げて見ていきましょう。
$p = 41$, $a = 8$ とします。

$p = 5 * 2^3 + 1$ なので、$q = 5, s = 3$ です。
$z$ として、ここでは 7 をとります。

$m := 3, c :\equiv 7^5 = 16807 \equiv 38, t :\equiv 8^5 = 32768 \equiv 9, r \equiv 8^3 = 512 \equiv 20$ となります。 (${} \bmod 41$ は適宜省略)

 \begin{table}[htb]
  \begin{center}
  \begin{tabular}[t]{|c|c|c|c|}
   \hline
   $m$ & $c$ & $t$ & $r$ \\ \hline
   3 & 38 & 9 & 20 \\
   2 & 9 & 40 & 22 \\
   1 & 40 & 1 & 34 \\ \hline
  \end{tabular}
  \end{center}
 \end{table}


よって、$x \equiv \pm 34 (=\mp 7)$ が答えになります。


以上のアルゴリズムで、4.のパートに無駄があります。4.では$c$と$m$しか変更していないので、$t^{2^i}\not \equiv 1 \pmod p$ となる最大の $i$ が見つけられれば、4.の操作をまとめることができます。このアイデアを使うのが、本来の Tonelli-Shanks のアルゴリズムです。

(TODO Wikipedia のTonelli-Shanks の説明)

\begin{itembox}[l]{COLUMN}
 群論的なアプローチをすると、もっと綺麗な見方が得られます。
$(\Z/p\Z)^* \cong \Z/(p-1)\Z \cong (\Z/2^s\Z) \times (\Z/q\Z)$ の2冪成分(2-Sylow部分群\index{Sylowぶぶんぐん@Sylow部分群}) $H = \Z/2^s\Z$ を考えます。このとき、$z$ と $t$ は $H$ の元であることがわかります。$t$が$1$になるように、うまく$H^2$の元で調整しているわけです。
\end{itembox}
 \section{平方剰余の相互法則\level{4}}
  \subsection{ルジャンドル記号}
  TODO ルジャンドル記号\index{るじゃんどるきごう@ルジャンドル記号}
  \subsection{平方剰余の相互法則}
  以下の定理が成り立つことが知られています。
  \begin{theorem}[平方剰余の相互法則]
   $p, q \ge 3$ を奇素数とする。このとき、以下が成立する。
   \begin{displaymath}
    \left(\frac{p}{q}\right)\left(\frac{q}{p}\right) = (-1)^{\frac{p-1}{2} \times \frac{q-1}{2}}
   \end{displaymath}
  \end{theorem}
  \begin{theorem}[補充法則]
   $p \ge 3$ を奇素数とする。このとき、以下が成立する。
   \begin{displaymath}
    \legendre{-1}{p} = (-1)^{\frac{p-1}{2}},
    \legendre{2}{p} = (-1)^{\frac{p^2-1}{8}}
   \end{displaymath}
  \end{theorem}
  これを利用することで、ルジャンドル記号を計算できます。
  \begin{example}
   \label{ex:legendre-3}
   $p \neq 2,3$を、2,3以外の素数とします。このとき、
   $\legendre{3}{p}$ は、$p$ を12で割った余りで完全に決まります。
   \begin{displaymath}
    \legendre{3}{p} = (-1)^{\frac{p-1}{2}}\legendre{p}{3}
   \end{displaymath}
   ここで、
   \begin{displaymath}
    \legendre{p}{3} = \begin{cases}
		       1 & \mbox{if }p\equiv 1 \pmod 3 \\
		       -1 & \mbox{if }p\equiv 2 \pmod 3
		      \end{cases}
   \end{displaymath}
   なので、
   \begin{displaymath}
    (-1)^{\frac{p-1}{2}} = \begin{cases}
			    1 & \mbox{if }p \equiv 1 \pmod 4 \\
			    -1 & \mbox{if }p \equiv 3 \pmod 4
			   \end{cases}
   \end{displaymath}
   と合わせ、
   \begin{displaymath}
    \legendre{3}{p} = \begin{cases}
		       1 & \mbox{if }p\equiv 1,11 \pmod{12} \\
		       -1 & \mbox{if }p\equiv 5,7 \pmod{12}
		      \end{cases}
   \end{displaymath}
   が得られます。
  \end{example}
  \subsection{2次体}
  \subsection{有限体}
  任意の素数$p$と正の整数$e$に対して、$p^e$要素の有限体が存在します。逆に、有限体の要素数は、必ず$p^e$ の形で表せます。このような有限体は、一意に存在します。これを$\finiteField{p^e}$と表記することにします。
  \subsection{フロベニウス写像}
  $\Frob \colon \finiteField{p^e} \to \finiteField{p^e}, \Frob(x) := x^p$ を\emph{フロベニウス写像}\index{ふろべにうすしゃぞう@フロベニウス写像}と呼びます。 TODO
  \begin{proposition}
   $\Frob$は$e$回適用すると元に戻る。つまり、$\Frob^e(x) = x$。
  \end{proposition}
  \begin{proposition}
   $x, \Frob(x), \Frob^2(x), \ldots, \Frob^{e-1}(x)$ は全て共役(TODO definition)。つまり、TODO。
  \end{proposition}
  \subsection{応用例}
  \begin{itembox}[l]{例題}
   数列 $a_0 = 2, a_{n+1} = a_n(a_n+4)$がある。このとき、素数$M$に対して、$a_N \bmod M$ を求めよ。

   (出典: yukicoder No.613 Solitude by the window)
  \end{itembox}
  この問題は、一般項を求めるところが一番難しく、一般項を求めた後は数論的な考察を進めるだけで解けます。
  ここでは、$a_n = (2+\sqrt{3})^{2^n} + (2-\sqrt{3})^{2^n} - 2$ であることがわかっているとして、この状態から問題を解いてみましょう。$a_n \bmod M$が計算できれば良いです。

  $(2+\sqrt{3})^{2^n} \bmod M$が計算できれば万事解決です。
  簡単のため、$M$が2でも3でもないとしましょう。先にも述べた(TODO)通り、3が${}\bmod M$で平方剰余なら(つまり$\legendre{3}{M}=1$なら)、議論は$\finiteField{M}$の中で完結できます。
  3が${}\bmod M$で平方非剰余(つまり$\legendre{3}{M}=-1$)の場合を考えます。
  このとき、$\finiteField{M}$に$\sqrt{3}$を添加して拡大したものは、$\finiteField{M^2}$と同型になります。
  \begin{displaymath}
   \finiteField{M}(\sqrt{3}) \cong \finiteField{M^2}
  \end{displaymath}
  ここで、$\Frob(2+\sqrt{3}) = (2+\sqrt{3})^M \in \finiteField{M^2}$がどのような元になるかを考えてみましょう。$2+\sqrt{3}$の共役は自分自身と$2-\sqrt{3}$のみなので、$\Frob(2+\sqrt{3})=2-\sqrt{3}$でなければなりません。これから、$(2+\sqrt{3})^{M+1}=(2-\sqrt{3})(2+\sqrt{3})=1$であることが分かります。
\printindex
\end{document}
